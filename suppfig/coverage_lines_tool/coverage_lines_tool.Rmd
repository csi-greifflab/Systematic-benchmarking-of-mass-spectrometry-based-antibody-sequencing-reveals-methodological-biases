---
title: "Coverage plot by tool"
author: "Khang"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning=F, message=F)
library(readxl)
library(seqinr)
library(tidyverse)
library(reshape2)
library(forcats)
library(RColorBrewer)
library(kableExtra)
library(gridExtra)
```

# Read in the filtered peptide list from the main dataset and the reference sequences
```{r}
cdr3 <- data.frame(read_tsv("./antibodies_cdr3_variable_full.tsv"))
cdr3$cdr3_start <- str_locate(cdr3$amino_acid_sequence_Vregion, cdr3$amino_acid_sequence_cdr3)[,1]
cdr3$cdr3_end <- str_locate(cdr3$amino_acid_sequence_Vregion, cdr3$amino_acid_sequence_cdr3)[,2]

##### Wronggg, import the all_peptides_processed.tsv
MQ_peptides <- read_tsv("../../../main_dataset/mq_ab_filtered.tsv")
MSF_peptides <- read_tsv("../../../main_dataset/msf_ab_filtered.tsv")
Casanovo_peptides <- read_tsv("../../../main_dataset/casanovo_ab_filtered.tsv")

MQ_peptides$Tool <- "MaxQuant"
MSF_peptides$Tool <- "MSFragger"
Casanovo_peptides$Tool <- "Casanovo"

# Merge all tools together, exclude intensity / search engine score
All_peptides <- rbind(MQ_peptides[,-5], MSF_peptides[,-5], Casanovo_peptides[,-5])

All_peptides$enzyme <- str_replace_all(All_peptides$enzyme, "aspn", "AspN")
All_peptides$enzyme <- str_replace_all(All_peptides$enzyme, "ct", "Ct")
All_peptides$enzyme <- str_replace_all(All_peptides$enzyme, "tryp", "Tryp")
All_peptides$enzyme <- str_replace_all(All_peptides$enzyme, "ct+tryp", "Ct+Tryp")

All_peptides$Tool <- as_factor(All_peptides$Tool)
levels(All_peptides$Tool) <-  c("MaxQuant", "MSFragger", "Casanovo")

Tool_cols <- c("MaxQuant" = "#00858a", "MSFragger" = "#e46e00", "Casanovo" = "#6a3e37")

All_peptides$match_ig_type <- str_replace_all(All_peptides$match_ig_type, "Bri", "Brimab")
All_peptides$match_ig_type <- str_replace_all(All_peptides$match_ig_type, "Ust", "Umab")

# exclude peptides labelled contamination
All_peptides <- All_peptides %>% filter(is_contamination == FALSE)
```

# Import function to calculate miscleavage and coverage

```{r}
source("../../utils.R")

# Calculate miscleavage for all exp peptides
All_peptides <- All_peptides %>% mutate(n_miscleavages = ifelse(enzyme == "Tryp", unlist(lapply(Sequence, function(x) calculate_miscleavages_trypsin(x))), ifelse(enzyme == "Ct", unlist(lapply(Sequence, function(x) calculate_miscleavages_chymotrypsin(x))), ifelse(enzyme == "AspN", unlist(lapply(Sequence, function(x) calculate_miscleavages_aspn(x))), ifelse(enzyme == "Ct+Tryp", unlist(lapply(Sequence, function(x) calculate_miscleavages_chymotrypsin(x))) + unlist(lapply(Sequence, function(x) calculate_miscleavages_trypsin(x))), 0)))))

# Remove peptides with > 2 miscleavage (predictions made by Casanovo)
#All_peptides <- All_peptides %>% filter(n_miscleavages <= 2)

# Summarize the df to keep only unique peptides per Ab (remove dup peptides from different samples)
Sum_peptides <- All_peptides %>% group_by(match_ig_type, Sequence, Tool, n_miscleavages) %>% summarize()
```

# Function to plot coverage
```{r}
make_coverage_plot <- function(ab_name, df) {
  peptides <- df$Sequence # peptides that perfectly march to an ab
  # Locate the position of the peptide sequence and the cdr3 in the V region
  res_seq <- str_locate(cdr3[cdr3$sequence_name == ab_name, ]$amino_acid_sequence_Vregion, as.character(peptides)) # position number of peptide on V region
  res_cdr3 <- str_locate(cdr3[cdr3$sequence_name == ab_name, ]$amino_acid_sequence_Vregion, as.character(cdr3[cdr3$sequence_name == ab_name, ]$amino_acid_sequence_cdr3)) # position number of the cdr3
  
  df_cdr3 <- data.frame(Sequence = peptides,
                        start = res_seq[, 1],
                        end = res_seq[, 2], 
                        Tool = as.factor(df$Tool),
                        n_miscleavages = as.factor(df$n_miscleavages))
  # Order the peptides based on starting position in the V region
  df_cdr3 <- df_cdr3[with(df_cdr3, order(start, -end)), ]
  df_cdr3$y <- 1:nrow(df_cdr3)

  df_cdr3_tmp <- melt(df_cdr3, c("Sequence", "y", "n_miscleavages", "Tool"))
  # Plot the coverage
  p_coverage <- ggplot(df_cdr3_tmp, aes(x=value, y=y)) +
    geom_rect(aes(xmin = res_cdr3[1, 1],
                  xmax = res_cdr3[1, 2],
                  ymin = -Inf, ymax = Inf), fill = "#FDFD96", alpha = 0.05) + #cdr3
    geom_point(size = 0.2) +
    geom_segment(aes(x = start, y = y, xend = end, yend = y, color = Tool, linetype = n_miscleavages), size = 1, data = df_cdr3) +
    scale_color_manual(values = Tool_cols) +
    scale_linetype_manual(values = c("0" = 1, "1" = 2, "2" = 3)) +
    #scale_x_continuous(breaks = c(seq(min(res_seq), max(res_seq), by = 20))) +
    guides(fill = guide_legend(keywidth = 1, keyheight = 1),
    linetype = guide_legend(keywidth = 3, keyheight = 1),
    colour = guide_legend(keywidth = 3, keyheight = 1)) +
    theme_classic() +
    theme(text = element_text(size = 24), legend.position = "none") +
    labs(x = "Position in the variable region", y = "", color = "Tool", linetype = "Miscleavages")
   
  ggsave(filename = paste0("./figures/",ab_name,".pdf"), plot = p_coverage, width = 14, height = 8, dpi = 600)
  p_coverage
}
```

```{r fig.height=8, fig.width=14}
for (match in cdr3$sequence_name) {
  make_coverage_plot(match, Sum_peptides[Sum_peptides$match_ig_type == match, ])
}
```

# Function to calculate coverage depth (count each tool separately)
```{r}
# Create an array of each position, starts with 0, take a peptide, for every position that peptide covers add 1 
get_coverage_position <- function(ab_name, df) {
  peptides <- df$Sequence # peptides that perfectly match to an ab
  res_seq <- str_locate(cdr3[cdr3$sequence_name == ab_name, ]$amino_acid_sequence_Vregion, as.character(peptides)) # position number of peptide on V region
  res_cdr3 <- str_locate(cdr3[cdr3$sequence_name == ab_name, ]$amino_acid_sequence_Vregion, as.character(cdr3[cdr3$sequence_name == ab_name, ]$amino_acid_sequence_cdr3)) # position number of the cdr3
  # List the position in the V region for each peptide in long format
  df_cdr3 <- data.frame(Sequence = peptides,
                        Tool = df$Tool,
                        start = res_seq[, 1],
                        end = res_seq[, 2])

  df_cdr3 <- df_cdr3[with(df_cdr3, order(start, -end)), ] # Order the peptides by position in V region
  df_cdr3$y <- 1:nrow(df_cdr3) # Value for y-axis

  df_cdr3_tmp <- melt(df_cdr3, c("Sequence", "y", "Tool")) # transform to long format
  
  print(df_cdr3) 
  }
```

```{r}
# Get the residue positions for all peptides
coverage_position_all <- list()
for (match in cdr3$sequence_name) {
  coverage_position_all[[match]] <- get_coverage_position(match, Sum_peptides[Sum_peptides$match_ig_type == match, ])
}

coverage_position_all

coverage_position_count <- list()
for(i in 1:length(coverage_position_all)){
  coverage_position_count[[i]] <- tibble(seq_name = names(coverage_position_all[i]),
                                         position = rep(seq(1:nchar(cdr3$amino_acid_sequence_Vregion[i])), each = 3),
                                         Tool = rep(c("MaxQuant", "MSFragger", "Casanovo"), nchar(cdr3$amino_acid_sequence_Vregion[i])),
                                         count = 0)
}
names(coverage_position_count) <- names(coverage_position_all)

# for each peptide that corresponding to the correct Tool, subset the rows in the count df corresponding to start and end, add 1

for(i in 1:length(coverage_position_all)){
  for(j in 1:nrow(coverage_position_all[[i]])){
    # create a sequence from "start" to "end"
    pos_seq <- seq(coverage_position_all[[i]]$start[j], coverage_position_all[[i]]$end[j])
    # get the value of "Tool" in the current row of coverage_position_all
    Tool <- coverage_position_all[[i]]$Tool[j]
    # subset coverage_position_count to get the matching rows
    subset_count <- coverage_position_count[[i]]$Tool == Tool &
                    coverage_position_count[[i]]$position %in% pos_seq
    # increment the "count" value by 1 for matching rows
  coverage_position_count[[i]]$count[subset_count] <- coverage_position_count[[i]]$count[subset_count] + 1
  }
}
```

```{r fig.height=2, fig.width=14}
ggplot(data = coverage_position_count[[3]], aes(x = position, y = count, fill = factor(Tool, levels = c("MaxQuant", "MSFragger", "Casanovo")))) +
  geom_rect(aes(xmin = cdr3$cdr3_start[3], xmax = cdr3$cdr3_end[3],
                ymin = -Inf, ymax = Inf), fill = "#FDFD96", alpha = 0.05) + #cdr3
  geom_col() +
  scale_fill_manual(values = Tool_cols) +
  scale_x_continuous(limits = c(0, max(coverage_position_count[[3]]$position))) +
  theme_classic() +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), legend.position = "none") +
  labs(x = "", y = "frequency")

p_coverage_position_count <- list()

for (i in 1:length(coverage_position_count)){
  p_coverage_position_count[[i]] <- ggplot(data = coverage_position_count[[i]], aes(x = position, y = count, fill = factor(Tool, levels = c("MaxQuant", "MSFragger", "Casanovo")))) +
  geom_rect(aes(xmin = cdr3$cdr3_start[i], xmax = cdr3$cdr3_end[i],
                ymin = -Inf, ymax = Inf), fill = "#FDFD96", alpha = 0.05) + #cdr3
  geom_col() +
  scale_fill_manual(values = Tool_cols) +
  theme_classic() +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), legend.position = "none", text = element_text(size = 24)) +
  labs(x = "")
  
  ggsave(filename = paste0("./figures/",names(coverage_position_count)[i],"_freq.pdf"), plot = p_coverage_position_count[[i]], width = 14, height = 2, dpi = 600)
}
```
